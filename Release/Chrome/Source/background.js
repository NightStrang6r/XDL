const debug=!0,moodleApi="https://dl.nure.ua/",XDLApi="https://xdl.leoit.dev/";let extendOnlineThread,autoAttendanceThread;async function Main(){if(!localStorage.sesskey)return;console.log(localStorage);let e=getFirstCourseId(getUserId());localStorage.attendanceId=getAttendanceId(e),startAutoAttendanceThread(),startExtendOnlineThread()}function log(e,t=!1){const n=new Date;let a=n.getDate(),s=n.getMonth()+1,o=n.getFullYear(),l=n.getHours(),r=n.getMinutes(),i=n.getMinutes();1==a.toString().length&&(a=`0${a}`),1==s.toString().length&&(s=`0${s}`),1==l.toString().length&&(l=`0${l}`),1==r.toString().length&&(r=`0${r}`),1==i.toString().length&&(i=`0${i}`);const d=`>[${a}.${s}.${o}] [${l}:${r}:${i}] >XDL: ${e}`;t?console.error(d):console.log(d)}function testAjax(){$.ajax({url:"https://dl.nure.ua",method:"get",success:e=>{console.log(e)}})}function startAutoAttendanceThread(){"true"===localStorage.autoAttendance&&(log("AutoAttendance thread started."),updateAttendanceList(),autoAttendanceThread=setInterval(updateAttendanceList,60*localStorage.attendanceTimeout*1e3))}function startExtendOnlineThread(){"true"===localStorage.extendOnline&&(log("ExtendOnline thread started."),extendOnlineThread=setInterval(extendLoginTimeout,3e5))}function stopAutoAttendanceThread(){clearInterval(autoAttendanceThread),log("AutoAttendance thread stopped.")}function stopExtendOnlineThread(){clearInterval(extendOnlineThread),log("ExtendOnline thread stopped.")}function obtainSesskey(){let e;try{$.ajax({url:moodleApi,method:"get",dataType:"html",async:!1,success:t=>{let n=parseDOM(t).getElementsByClassName("logininfo")[0].lastElementChild.href;log((e=n.split("=")[1])&&null!=e?`Successfully obtained session key: ${e}`:"Failed to obtain sesskey: user need to log in DL.")}})}catch(e){log(`Failed to obtain sesskey. Error: ${e}`)}return e}function sendLoginState(){try{$.ajax({url:"https://dl.nure.ua",method:"get",dataType:"html",async:!0,success:e=>{let t=parseDOM(e).getElementsByClassName("logininfo")[0].lastElementChild.href;sesskey=t.split("=")[1];let n=!1;n=!(!sesskey||null==sesskey),chrome.runtime.sendMessage({greeting:"setLoginState",state:n})}})}catch(e){return!1}}function setOnlineFunctions(){}function getAttendanceId(e){if(!e)return;let t;return $.ajax({url:`${moodleApi}/course/view.php`,method:"get",dataType:"html",async:!1,data:{id:e},success:e=>{const n=parseDOM(e);try{t=n.getElementsByClassName("attendance")[0].firstElementChild.firstElementChild.lastElementChild.firstElementChild.firstElementChild.href.split("=")[1]}catch(e){log("Failed to get AttendanceId.")}}}),log(`AttendanceId: ${t} Link: ${moodleApi}mod/attendance/view.php?id=${t}&mode=2&view=5&sesscourses=all`),t}function getFirstCourseId(e){if(!e)return;let t;return $.ajax({url:`${moodleApi}lib/ajax/service.php?sesskey=${localStorage.sesskey}&info=core_course_get_recent_courses`,method:"post",dataType:"json",async:!1,data:`[{"index":0,"methodname":"core_course_get_recent_courses","args":{"userid":${e},"limit":1}}]`,contentType:"application/json",success:e=>{(e=e[0])&&!e.error&&(t=e.data[0].id)}}),log(`CourseId: ${t}`),t}function getUserId(){let e;try{$.ajax({url:moodleApi,method:"get",dataType:"html",async:!1,success:t=>{let n=parseDOM(t).getElementsByClassName("logininfo")[0].firstElementChild.href;log((e=n.split("=")[1])&&null!=e?`UserId: ${e}`:"Failed to get UserId.")}})}catch(e){log(`Failed to get UserId Error: ${e}`)}return e}function extendLoginTimeout(){localStorage.sesskey&&$.ajax({url:`${moodleApi}lib/ajax/service.php?sesskey=${localStorage.sesskey}&info=core_session_touch`,method:"post",dataType:"json",data:'[{"index":0,"methodname":"core_session_touch","args":{}}]',contentType:"application/json",success:e=>{log("Login timeout updated")},error:e=>{log("Failed to update login timeout")}})}function updateAttendanceList(){localStorage.attendanceId?$.ajax({url:`${moodleApi}mod/attendance/view.php`,method:"get",dataType:"html",data:{id:193690,mode:2,view:5,sesscourses:"all"},success:e=>{let t=getAllIndexes(e,"attendance.php?"),n="";t[0]?t.forEach(t=>{for(let a=t;'"'!=e[a];a++)n+=e[a];log(n),setAttendance(n),n=""}):log("Нет доступных полей для отметки посещения.")}}):log(`Invalid attendanceId: ${localStorage.attendanceId}. Can't updateAttendanceList`)}function setAttendance(e){let t=`${moodleApi}mod/attendance/${e}`;$.ajax({url:t,method:"get",dataType:"html",success:n=>{if(n.includes("Сохранить")){let a,s,o,l=parseDOM(n).getElementsByClassName("statusdesc");for(let e=0;e<l.length;e++)"Присутствовал"!=l[e].innerHTML&&"Присутній"!=l[e].innerHTML||(o=l[e].parentElement.firstElementChild.value);o&&(a=getQueryVariable(e,"sessid"),s=getQueryVariable(e,"sesskey"),$.ajax({url:t,method:"post",data:{sessid:a,sesskey:s,_qf_mod_attendance_form_studentattendance:1,mform_isexpanded_id_session:1,status:o,submitbutton:"Сохранить"},success:e=>{sendAttendanceMail(t),log("Посещение отмечено. (adv)")}}))}else sendAttendanceMail(t),log("Посещение отмечено.")}})}function sendAttendanceMail(e){let t=localStorage.email;localStorage.visitNotify&&t&&void 0!==t&&$.ajax({url:`${XDLApi}mail/`,method:"post",dataType:"html",data:{email:t,link:e},success:e=>{log(`Запрос об отправке письма на почту ${t} отправлен. Ответ: ${e}`)}})}function parseDOM(e){return(new DOMParser).parseFromString(e,"text/html")}function getAllIndexes(e,t){for(var n=[],a=-1;-1!=(a=e.indexOf(t,a+1));)n.push(a);return n}function getQueryVariable(e,t){let n=e.replace("?","&").substring(1).split("&");for(let e=0;e<n.length;e++){let a=n[e].split("=");if(decodeURIComponent(a[0])==t)return decodeURIComponent(a[1])}return null}function onMessage(e,t,n){if("saveSettings"==e.greeting){let t={};Object.assign(t,localStorage);for(let t in e.settings)localStorage[t]=e.settings[t];t.autoAttendance!=localStorage.autoAttendance&&(stopAutoAttendanceThread(),startAutoAttendanceThread()),t.extendOnline!=localStorage.extendOnline&&(stopExtendOnlineThread(),startExtendOnlineThread()),t.sAutoAttendance==localStorage.sAutoAttendance&&t.sExtendOnline==localStorage.sExtendOnline||setOnlineFunctions(),n({farewell:"Сохранено"})}"getSettings"==e.greeting&&n({settings:localStorage}),"saveEmail"==e.greeting&&(localStorage.email=e.email,n({farewell:"OK"})),"saveAttendanceTimeout"==e.greeting&&(localStorage.attendanceTimeout=e.timeout,n({farewell:"OK"})),"saveAuth"==e.greeting&&(e.auth&&e.auth.sesskey&&e.auth.session?(localStorage.sesskey!=e.auth.sesskey&&(localStorage.sesskey=e.auth.sesskey,log(`Received new session key: ${localStorage.sesskey}`)),localStorage.session!=e.auth.session&&(localStorage.session=e.auth.session,log(`Received new session: ${localStorage.session}`)),n({farewell:"OK"})):n({farewell:"FAIL"})),"checkLoginState"==e.greeting&&sendLoginState()}log("Background.js loading..."),chrome.runtime.onMessage.addListener(onMessage),localStorage.sesskey=obtainSesskey(),localStorage.attendanceTimeout||(localStorage.attendanceTimeout=5),Main(),log("Background.js loaded.");